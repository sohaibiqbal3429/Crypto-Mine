# Unified reverse proxy rate limiting - token bucket 50 req/s per IP, 200 req/s per API key, burst 2000
# Static content and health checks bypass throttling.

limit_req_zone $binary_remote_addr zone=ip_rate:20m rate=50r/s;
limit_req_zone $http_x_api_key zone=api_key_rate:20m rate=200r/s;
limit_req_status 429;
limit_req_log_level notice;
map $request_uri $is_static_route {
  default 0;
  ~^/static 1;
  ~^/assets 1;
  ~^/images 1;
  ~^/cdn/ 1;
  /status 1;
}

map $remote_addr $is_whitelisted_ip {
  default 0;
  127.0.0.1 1;
  ::1 1;
  10.0.0.0/8 1;
  172.16.0.0/12 1;
  192.168.0.0/16 1;
}

map $http_x_api_key $rate_limit_scope {
  default "ip,api-key";
  "" "ip";
}

server {
  listen 443 ssl http2;
  server_name api.mintminepro.com;

  set $rate_limit_burst 2000;
  set $limit_rate_enabled 1;

  if ($is_static_route = 1) {
    set $limit_rate_enabled 0;
  }

  if ($is_whitelisted_ip = 1) {
    set $limit_rate_enabled 0;
  }

  if ($limit_rate_enabled != 0) {
    limit_req zone=ip_rate burst=$rate_limit_burst nodelay;
    if ($http_x_api_key != "") {
      limit_req zone=api_key_rate burst=$rate_limit_burst nodelay;
    }
  }

  error_page 429 = @rate_limited;

  location @rate_limited {
    default_type application/json;
    add_header Retry-After "1" always;
    add_header X-Backoff-Hint "2" always;
    add_header X-RateLimit-Layer "reverse-proxy";
    add_header X-RateLimit-Scope $rate_limit_scope;
    return 429 '{"error":"Too many requests","layer":"reverse-proxy"}';
  }

  location / {
    proxy_pass http://app_backend;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $host;
  }
}
